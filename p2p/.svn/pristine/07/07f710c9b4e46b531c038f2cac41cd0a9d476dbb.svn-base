package p2p.application.peer.components;

import p2p.application.messages.PositionUpdate;
import p2p.application.messages.PatchUpdate;
import p2p.application.peer.IPeerComponent;
import p2p.application.peer.Peer;
import p2p.data.IntPair;
import p2p.network.IEndPoint;

public class UpdateManager implements IPeerComponent
{
	private IEndPoint mEndPoint;
	
	private Peer mOwner;
	
	private IntPair mPreviousPatch;
	
	private IntPair mPreviousPos;
	
	public UpdateManager(Peer owner, IEndPoint messagingEndPoint) 
	{
		mOwner = owner;
		
		mEndPoint = messagingEndPoint;
	}
	
	@Override
	public void update(long deltaTime) 
	{
		if(mPreviousPos == null || mOwner.currentPos.equals(mPreviousPos) == false)
		{
			PositionUpdate advertisement = new PositionUpdate(mOwner.currentPos);

			mEndPoint.castMessage("patch_" + mOwner.currentPatch.getX() + "_" + mOwner.currentPatch.getY(), advertisement);
			
			mPreviousPos = mOwner.currentPos;
		}
		
		if(mPreviousPatch == null || mOwner.currentPatch.equals(mPreviousPatch) == false)
		{
			PatchUpdate patchPosUpdate = new PatchUpdate(mPreviousPatch, mOwner.currentPatch);
			
			if(mPreviousPatch != null)
			{
				mEndPoint.castMessage("patch_" + mPreviousPatch.getX() + "_" + mPreviousPatch.getY(), patchPosUpdate);
			}
			
			mEndPoint.castMessage("patch_" + mOwner.currentPatch.getX() + "_" + mOwner.currentPatch.getY(), patchPosUpdate);
			
			mPreviousPatch = mOwner.currentPatch;
		}
	}
}
